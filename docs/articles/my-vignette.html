<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>sortingmod • sortingmod</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">sortingmod</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/my-vignette.html">sortingmod</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>sortingmod</h1>
                        <h4 class="author">Thomas de Graaff and Or Levkovich</h4>
            
            <h4 class="date">2017-08-02</h4>
          </div>

    
    
<div class="contents">
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p><code>sortingmod</code> is a package for estimating the sorting model - a discrete choice model which explains the location decision of heterogeneous individuals over a set of alternative locations. The model is developed by Bayer et al. (2004) following the work of Berry et al. (1995). It relies on the assumptions that individuals choose a location that maximizes their utility, and that heterogeneous individuals with different characteristics have different preferences, and different valuation for location characteristics. The results of the model provide choice probabilities for each alternative, as well as insight on the valuation patterns of heterogeneous agents, and marginal willingness-to-pay values for location characteristics.</p>
<p>The package is constructed as an accompanying tool for the Summer School in “Hedonic price analysis and the residential location choice”, hosted by the Kraks Fond - Institute for Urban Economic Research (Copenhagen, Denmark).</p>
</div>
<div id="estimation-of-the-residential-sorting-model" class="section level2">
<h2 class="hasAnchor">
<a href="#estimation-of-the-residential-sorting-model" class="anchor"></a>Estimation of the residential sorting model</h2>
<p><code>Sortingmod</code> package follows the methodology described in Bayer et al. (2004) to analyze how heterogeneous individuals sort themselves into alternative locations based on their preferneces for local characteristics.</p>
<p><code>sortingmod</code> solves the following model:</p>
<p><span class="math display">\[U_{j}^{i}  =  \sum_{k=1}^{K}\beta_{k,0}X_{k,j} + \sum_{k=1}^{K}\sum_{l=1}^{L}\beta_{k,l}(Z^{i}_{l}-\bar{Z_{l}})X_{k,j} + \xi_j + \epsilon_{j}^{i}\]</span></p>
<p>Where: <span class="math inline">\(U_{j}^{i}\)</span> is the utility of individual <span class="math inline">\(i\)</span> from alternative <span class="math inline">\(j\)</span>, <span class="math inline">\(X_{k,j}\)</span> is the value of the <span class="math inline">\(k\)</span>-th alternative characteristic in location <span class="math inline">\(j\)</span>, <span class="math inline">\(Z^{i}_{l}\)</span> is the value of the <span class="math inline">\(l\)</span>-th characteristic of individual <span class="math inline">\(i\)</span>, <span class="math inline">\(\bar{Z_{l}}\)</span> is the sample mean of individual characteristic <span class="math inline">\(l\)</span>, <span class="math inline">\(\beta_{k,l}\)</span> is the cross effect coefficients, <span class="math inline">\(\xi_j\)</span> is an alternative specific error term, and <span class="math inline">\(\epsilon_{j}^{i}\)</span> is the individual error term.</p>
<p>Due to likely correlation between prices and unobserved characteristics, it is necessary to estimate the sorting model in two stages.(See discussion in Berry et al. (1995)).</p>
<div id="first-stage" class="section level3">
<h3 class="hasAnchor">
<a href="#first-stage" class="anchor"></a>First stage</h3>
<p>The first stage of the sorting model involves estimating the cross effect coefficients, and treating <span class="math inline">\(\delta_{j} = \sum_{k=1}^{K}\beta_{k,0}X_{k,j}\)</span> as alternative specific constants. Assuming that the random term is IID extreme value type I distributed, choice probabilities can be derived by a logit model estimation:</p>
<p><span class="math display">\[P^{i}_{j} = \frac{e^{V_{j}^{i}}}{\sum_{j=1}^{J}e^{V_{j}^{i}}} = \frac{e^{(\delta_{j} + \sum_{k=1}^{K}\sum_{l=1}^{L}\beta_{k,l}(Z^{i}_{l}-\bar{Z_{l}})X_{k,j})}}{\sum_{j=1}^{J}e^{(\delta_{j} + \sum_{k=1}^{K}\sum_{l=1}^{L}\beta_{k,l}(Z^{i}_{l}-\bar{Z_{l}})X_{k,j})}}\]</span></p>
<p>The cross-effect coefficients and alternative specific constants are estimated by maximizing the probability that individual <span class="math inline">\(i\)</span> choose location <span class="math inline">\(j\)</span>, using a maximum likelihood procedure (BHHH (Berndt et al., 1974)).</p>
</div>
<div id="second-stage" class="section level3">
<h3 class="hasAnchor">
<a href="#second-stage" class="anchor"></a>Second stage</h3>
<p>The second stage of the estimation involves estimating the equation:</p>
<p><span class="math display">\[\delta_{j} = \sum_{k=1}^{K}\beta_{k,0}X_{k,j} + \xi_j\]</span></p>
<p>where the vector of mean indirect utilities (<span class="math inline">\(\delta_{j}\)</span>) is explained by the alternative characteristics.</p>
</div>
<div id="endogeneity-in-the-observed-alternative-characteristics" class="section level3">
<h3 class="hasAnchor">
<a href="#endogeneity-in-the-observed-alternative-characteristics" class="anchor"></a>Endogeneity in the observed alternative characteristics</h3>
<p>Since prices are likely to be correlated with the error term <span class="math inline">\(\xi_j\)</span> the second stage estimation follows a two stage least squares (2SLS) procedure to account for this endogeneity problem. Here, we follow the approach of  for instrument construction and construct a price instrument assuming no correlation exists with unobserved location heterogeneity. Namely, we compute the price vector which would clear the market under the assumption of <span class="math inline">\((\xi_j = 0)\)</span>.</p>
</div>
</div>
<div id="quick-user-guide" class="section level2">
<h2 class="hasAnchor">
<a href="#quick-user-guide" class="anchor"></a>Quick user guide</h2>
<div id="installation" class="section level3">
<h3 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h3>
<p>The purpose of this section is to give a general sense of the package, its components and an overview of how to use it. <code>sortingmod</code> is not currently available from CRAN, but you can install the development version from github with (note that you need to install the package <code>devtools</code> to be able to install packages from GitHub:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># install.packages("devtools")</span>
<span class="co"># library("devtools")</span>
devtools::<span class="kw">install_github</span>(<span class="st">"thdegraaff/sortingmod"</span>)</code></pre></div>
<p>Once installation is completed, the package can be loaded.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(sortingmod)</code></pre></div>
</div>
<div id="data-structure" class="section level3">
<h3 class="hasAnchor">
<a href="#data-structure" class="anchor"></a>Data structure</h3>
<p>The data for the estimation should be in data frame format, and it must contain:</p>
<ul>
<li>One or more columns indicating characteristics of a unique agent making a discrete choice between available alternatives (individuals, households, etc.).</li>
<li>A vector indicating the chosen alternative.</li>
<li>One or more columns indicating characteristics of the chosen alternative.</li>
</ul>
<p>Users can work on their own data, or use the data which is saved in the workspace.</p>
<pre><code>##           id age    income hh_kids mun_code  lnprice    nature monuments
## 1 1202400414  46 11.248465       1       34 12.04515 0.1879051  2.639057
## 2 1201400454  56 11.493365       0       34 12.04515 0.1879051  2.639057
## 3 1109400358  22  9.588434       1       34 12.04515 0.1879051  2.639057
## 4 1202400342  35 11.446497       1       34 12.04515 0.1879051  2.639057
## 5 1110400442  49 11.040759       1       34 12.04515 0.1879051  2.639057
## 6 1201400437  49 10.672785       1       34 12.04515 0.1879051  2.639057</code></pre>
<p>Notes:</p>
<ul>
<li>Each row represents a unique individual. The number of alternatives should therefore be smaller or equal to the number of individuals.</li>
<li>Individual and alternative characteristics should be numeric variables. Factor variables are not yet supported, so it’s best to transform them into numeric dummy variables if you intend to include them in the model.</li>
</ul>
</div>
<div id="first-stage-estimation" class="section level3">
<h3 class="hasAnchor">
<a href="#first-stage-estimation" class="anchor"></a>First stage estimation</h3>
<p>The function <code>first_stage</code> is used in order to estimate the first stage of the model. <code>first_stage</code> takes four arguments:</p>
<ul>
<li>
<code>code_name</code> - which indicates (with name or column number) the vector with alternative chosen.</li>
<li>
<code>Z_names</code> - which indicates (with names or column numbers) the vectors with individual data.</li>
<li>
<code>X_names</code> - which indicates (with names or column numbers) the vectors with alternative data.</li>
<li>
<code>data</code> - which indicates the Data to be used.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  code_name =<span class="st"> </span><span class="kw">c</span>(<span class="st">"mun_code"</span>)
  X_names =<span class="st"> </span><span class="kw">c</span>(<span class="st">"lnprice"</span>,<span class="st">"kindergardens_1km"</span>,<span class="st">"p_mig_west"</span>,<span class="st">"nature"</span>,<span class="st">"monuments"</span>,<span class="st">"cafes_1km"</span>)
  Z_names =<span class="st"> </span><span class="kw">c</span>(<span class="st">"income"</span>,<span class="st">"double_earner_hh"</span>,<span class="st">"hh_kids"</span>,<span class="st">"age"</span>, <span class="st">"migskill"</span>)
  s1.results &lt;-<span class="st"> </span><span class="kw"><a href="../reference/first_stage.html">first_stage</a></span>(code_name, Z_names, X_names, <span class="dt">data =</span> municipality, <span class="dt">print_detail =</span> <span class="dv">1</span>)</code></pre></div>
<p>s1.results is a (maxLik) object, containing the estimation results and all relevant information. Several methods can be called on the object, including <code>summary, coef,</code> and <code>stdEr</code>. Calling <code>summary</code> provides a neat summary of the estimation, including the coefficients and std. errors of the cross-effect coefficients and the alternative-specific constants, which will later be used in the second stage of the estiamtion.</p>
</div>
<div id="second-stage-estimation" class="section level3">
<h3 class="hasAnchor">
<a href="#second-stage-estimation" class="anchor"></a>Second stage estimation</h3>
<p>The function <code>second_stage</code> is used in order to estimate the first stage of the model. <code>second_stage</code> takes four arguments:</p>
<ul>
<li>
<code>s1.results</code> - which indicates the (maxLik) object estimation results of the first stage of the sorting model.</li>
<li>
<code>data</code> - which indicates the Data to be used.</li>
<li>
<code>endog</code> - (optional) which indicates the endogenous variable(s) to be instrumented (from the dataset in parentheses).</li>
<li>
<code>instr</code> - (optional) which indicates the intrument(s) for the endogenous variable.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  s2.results &lt;-<span class="st"> </span><span class="kw"><a href="../reference/second_stage.html">second_stage</a></span>(s1.results, data)
  
  endog &lt;-<span class="st"> </span>(<span class="st">"lnprice"</span>)
  s2.results &lt;-<span class="st"> </span><span class="kw"><a href="../reference/second_stage.html">second_stage</a></span>(s1.results, <span class="dt">data =</span> municipality, <span class="dt">endog =</span> endog, <span class="dt">instr =</span> instrument)
  <span class="kw">summary</span>(s2.results)</code></pre></div>
<p>Before estimating the second stage of the model it is important to consider that some alternative characteristics are likely to be endogenous. For example, local price levels are very likely to be correlated with unobserved alternative features. For this reason the <code>second_stage</code> function allows (and encourages) users to include instruments in this part of the model estimation, using the options <code>endog</code> to indicate the endogenous variable(s), and <code>instrument</code> to indicate the chose instrument(s).</p>
</div>
<div id="calculating-the-market-equilibrium-instrument" class="section level3">
<h3 class="hasAnchor">
<a href="#calculating-the-market-equilibrium-instrument" class="anchor"></a>Calculating the market equilibrium instrument</h3>
<p><code>sortingmod</code> also includes the function <code>sorting_inst</code>, which generates an instrument which rises “naturally” from the model and utilizes its equilibrium properties, following Bayer et al. (2004). The calculated instrument is an instrument which clears the market assuming no correlation exists with unobserved heterogeneity between alternatives, and it is calculated in an interative process based on the results of the first stage of the estimation process.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  endog &lt;-<span class="st"> </span>(<span class="st">"lnprice"</span>)
  phat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sorting_inst.html">sorting_inst</a></span>(s1.results, endog, <span class="dt">data =</span> municipality, <span class="dt">stepsize =</span> <span class="fl">0.02</span>)</code></pre></div>
<pre><code>## Warning: package 'bindrcpp' was built under R version 3.4.1</code></pre>
<p><code>sorting_inst</code> takes several (non-optional) arguments:</p>
<ul>
<li>
<code>s1.results</code> - which indicates the (maxLik) object estimation results of the first stage of the sorting model.</li>
<li>
<code>endog</code> - which indicates the endogenous variable to be instrumented.</li>
<li>
<code>data</code> Dataset to be used.</li>
</ul>
<p>Unlike <code>first_stage</code>, <code>sorting_inst</code> does not take chosen alternatives, individual characteristics or alternative characteristics as arguments. This is because they are already specified as arguments in the <code>s1.results</code> object. However, note that <code>data</code> must indicate the same data used for the first stage estimation, and that the indicated endogenous variable must be included in the set of alternative characteristics used in the estimation (and specified in <code>X_names</code>).</p>
<p><code>sorting_inst</code> returns a list which contains (1) Results of the IV estimation, with the computed vector as instrument for the endogenous variable. (2) a vector of the computed instrument, and (3) the correlation between the computed instrument and the original variable.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(phat$IV_results)</code></pre></div>
<pre><code>## 
## Call:
## ivreg(formula = formula_iv, data = data_alt, weights = 1/se.weights)
## 
## Residuals:
##       Min        1Q    Median        3Q       Max 
## -25.39717  -3.63648   0.07974   4.27760  19.50532 
## 
## Coefficients:
##                   Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)       322.6482    93.9647   3.434 0.000803 ***
## lnprice           -26.9416     7.7619  -3.471 0.000708 ***
## kindergardens_1km   0.3002     0.3559   0.843 0.400537    
## p_mig_west          0.5586     0.1965   2.843 0.005203 ** 
## nature              7.6055     3.5850   2.121 0.035810 *  
## monuments           0.9410     0.3745   2.513 0.013215 *  
## cafes_1km          -0.4035     0.1633  -2.470 0.014822 *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 7.624 on 128 degrees of freedom
## Multiple R-Squared: -4.699,  Adjusted R-squared: -4.966 
## Wald test: 3.742 on 6 and 128 DF,  p-value: 0.001831</code></pre>
<p>Notes:</p>
<ul>
<li>The iteration process breaks if it identifies that values are not converging. Lack of convergence can be due to too much unobserved heterogeneity in the model, but it may also be that the contraction mapping coefficient (<code>stepstize</code> argument) is too large, which cause the iteration to overshoot. So before updating your model, try to experiment and choose lower stepsize values.</li>
<li>
<code>sorting_inst</code> accepts only one argument for endogenous variable as input, and subsequently also returns only a single vector as instrument.</li>
</ul>
</div>
<div id="marginal-willingness-to-pay-values" class="section level3">
<h3 class="hasAnchor">
<a href="#marginal-willingness-to-pay-values" class="anchor"></a>Marginal willingness-to-pay values</h3>
<p>The sorting model allows calculating the marginal willingness to pay (MWTP) for the various alternative characteristics examined of each type of individual (with distinct observable characteristics). These MWTP values give a clear overview of the impact of different alternative characteristics on the location choice of heterogeneous individuals, with respect to the monetary value price of a standard house. With the full estimation results in hand, the computation of the marginal willingness to pay is relatively simple (see detailed explanation in Bayer et al (2004), Van Duijn and Rouwendal (2013)).</p>
</div>
<div id="references" class="section level3">
<h3 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h3>
<p>Bayer, P., McMillan, R., &amp; Rueben, K. (2004). An equilibrium model of sorting in an urban housing market (No. w10865). National Bureau of Economic Research.</p>
<p>Berry, S., Levinsohn, J., &amp; Pakes, A. (1995). Automobile prices in market equilibrium. Econometrica: Journal of the Econometric Society, 841-890.</p>
<p>van Duijn, M., Rouwendal, J., sep 2013. Cultural heritage and the location choice of Dutch households in a residential sorting model. Journal of Economic Geography 13 (3), 473–500</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#estimation-of-the-residential-sorting-model">Estimation of the residential sorting model</a></li>
      <li><a href="#quick-user-guide">Quick user guide</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Thomas de Graaff, Or Levkovich.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
