---
title: "sortingmod"
author: "Thomas de Graaff and Or Levkovich"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction
sortingmod is a package for estimating the sorting model - a discrete choice model which explains the location decision of heterogeneous individuals over a set of alternative locations. The model is developed by Bayer et al. (2004) following the work of Berry et al. (1995). It relies on the assumptions that individuals choose a location that maximizes their utility, and that heterogeneous individuals with different characteristics have different preferences, and different valuation for location characteristics. The results of the model provide choice probabilities for each alternative, as well as insight on the valuation patterns of heterogeneous agents, and marginal willingness-to-pay values for location characteristics.

The package is constructed as an accompanying tool for the Summer School in “Hedonic price analysis and the residential location choice”, hosted by the Kraks Fond - Institute for Urban Economic Research (Copenhagen, Denmark).

## Installation



### Estimation of the residential sorting model
`Sortingmod` package follows the methodology described in Bayer et al. (2004) to analyze how heterogeneous individuals sort themselves into alternative locations based on their preferneces for local characteristics. 

`sortingmod` solves the following model:

$$U_{j}^{i}  =  \sum_{k=1}^{K}\beta_{k,0}X_{k,j} + \sum_{k=1}^{K}\sum_{l=1}^{L}\beta_{k,l}(Z^{i}_{l}-\bar{Z_{l}})X_{k,j} + \xi_j + \epsilon_{j}^{i}$$

Where:
		$U_{j}^{i}$ is the utility of individual $i$ from alternative $j$,
		$X_{k,j}$ is the value of the $k$-th alternative characteristic in location $j$, 
		$Z^{i}_{l}$ is the value of the $l$-th characteristic of individual $i$,
		$\bar{Z_{l}}$ is the sample mean of individual characteristic $l$,
		$\beta_{k,l}$ is the cross effect coefficients,
		$\xi_j$ is an alternative specific error term, and
		$\epsilon_{j}^{i}$ is the individual error term.  
		
Due to likely correlation between prices and unobserved characteristics, it is necessary to estimate the sorting model in two stages.(See discussion in Berry et al. (1995)).


## First stage
The first stage of the sorting model involves estimating the cross effect coefficients, and treating $\delta_{j} = \sum_{k=1}^{K}\beta_{k,0}X_{k,j}$ as alternative specific constants. Assuming that the random term is IID extreme value type I distributed, choice probabilities can be derived by a logit model estimation:

$$P^{i}_{j} = \frac{e^{V_{j}^{i}}}{\sum_{j=1}^{J}e^{V_{j}^{i}}} = \frac{e^{(\delta_{j} + \sum_{k=1}^{K}\sum_{l=1}^{L}\beta_{k,l}(Z^{i}_{l}-\bar{Z_{l}})X_{k,j})}}{\sum_{j=1}^{J}e^{(\delta_{j} + \sum_{k=1}^{K}\sum_{l=1}^{L}\beta_{k,l}(Z^{i}_{l}-\bar{Z_{l}})X_{k,j})}}$$

The cross-effect coefficients and alternative specific constants are estimated by maximizing the probability that individual $i$ choose location $j$, using a maximum likelihood procedure (BHHH (Berndt et al., 1974)).

## Second stage
The second stage of the estimation involves estimating the equation: 

$$\delta_{j} = \sum_{k=1}^{K}\beta_{k,0}X_{k,j} + \xi_j$$

where the vector of mean indirect utilities ($\delta_{j}$) is explained by the alternative characteristics. 


## Endogeneity in the observed alternative characteristics

Since prices are likely to be correlated with the error term $\xi_j$ the second stage estimation follows a two stage least squares (2SLS) procedure to account for this endogeneity problem.
Here, we follow the approach of \citet{Bayer2004} for instrument construction and construct a price instrument assuming no correlation exists with unobserved location heterogeneity. Namely, we compute the price vector which would clear the market under the assumption of $(\xi_j = 0)$.


## Quick start

The purpose of this section is to give a general sense of the package, its components and an overview of how to use it. 

First, we load the package :
```{r}
library(sortingmod)
```

Users can work on their own data, or use the data which is saved in the workspace.

```{r}
load("~/sortingmod/data/municipality.rda")
```

The data for the estimation should be in data frame format, which contains separate columns for individual characteristics, the chosen alternative and its characteristics. 

```{r}
head(municipality)
```

The function `first_stage` is used in order to estimate the first stage of the model. `first_stage` takes four arguments: 

- `code_name` - which indicates (with name or column number) the vector with alternative chosen.
- `Z_names` - which indicates (with names or column numbers) the vectors with individual data.
- `X_names` - which indicates (with names or column numbers) the vectors with alternative data.
- `dat` - which indicates the Data to be used.

```{r, results = "hide"}
code_name <- c("mun_code")
Z_names <- c("age","income")
X_names <- c("lnprice","nature","monuments")
s1.results <- first_stage(code_name, Z_names, X_names, dat = municipality)
```

s1.results is a (maxLik) object, containing the estimation results and all relevant information. Several methods can be called on the object, including `summary, coef,` and `stdEr`. Calling `summary` provides a neat summary of the estimation, including the coefficients and std. errors of the cross-effect coefficients and the alternative-specific constants, which will later be used in the second stage of the estiamtion. 

```{r}
summary(s1.results)
```

Before estimating the second stage of the model it is important to consider that some alternative characteristics are likely to be endogenous. For example, local price levels are very likely to be correlated with unobserved alternative features. 

The `second_stage` function contains an optional (but recommended argument to include an instrumental variable. However, `sortingmod` also includes the function `sorting_inst`, that generates an instrument following Bayer et al. (2004). The calculation of the instrument  utilizes the equilibrium properties of the model, and results in an instrument which clears the market assuming no correlation exists with unobserved heterogeneity between alternatives.

`sorting_inst` takes several (non-optional) arguments: 

- `s1.results` - which indicates the (maxLik) object estimation results of the first stage of the sorting model.
- `endog` - which indicates the endogenous variable to be instrumented.
- `dat` Dataset to be used.

Unlike `first_stage`, `sorting_inst` does not take chosen alternatives, individual characteristics or alternative characteristics as arguments. This is because they are already specified as arguments in the `s1.results` object.
However, note that `dat` must indicate the same data used for the first stage estimation, and that the indicated endogenous variable must be included in the set of alternative characteristics used in the estimation (and specified in `X_names`).

```{r, results = "hide"}
# endog <- c("lnprice")
# inst.var <- sorting_inst(s1.results, endog, dat = municipality) ### Returns an error when build & reload
```

`sorting_inst` returns a list `inst.var` which contains the vector of the instrument, and the correlation of the instrument with the original endogenous variable.

## Post estimation
### Marginal willingness-to-pay values
### References

Bayer, P., McMillan, R., & Rueben, K. (2004). An equilibrium model of sorting in an urban housing market (No. w10865). National Bureau of Economic Research.

Berry, S., Levinsohn, J., & Pakes, A. (1995). Automobile prices in market equilibrium. Econometrica: Journal of the Econometric Society, 841-890.

### Appendix

### .
### .

### Vignette defaults

Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The `html_vignette` output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible. The `html_vignette` format:

- Never uses retina figures
- Has a smaller default figure size
- Uses a custom CSS stylesheet instead of the default Twitter Bootstrap style

## Vignette Info

Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette.

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output: 
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
